<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src='/Front_end/JavaScript/templateLoader.js'></script>
    <title>Edit Profile</title>
    <link href="styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
</head>
<body>
<header></header>
<nav></nav>
<main>
    <div class="edit_profile_container">

        <div class="profile_change_image">
            <img src="../Images/usuario_generico.png" id="ProfileImage" alt="">
            <p>Change Photo</p>
        </div>

        <div class="name_username_email">
            <div class="profile_name">
                <p>Name:</p>
                <label for="name"></label><input type="text" id="name" placeholder="Name">
            </div>

            <div class="profile_username">
                <p>Username</p>
                <label for="username"></label><input type="text" id="username" placeholder="Username">
            </div>

            <div class="profile_email">
                <p>Email:</p>
                <label for="email"></label><input type="email" id="email" placeholder="Email">
            </div>
        </div>

        <div class="save_and_exit_buttons">
            <div class="save_button">
                <button id="saveBtn">Save</button>
            </div>

            <div class="exit_button">
                <button id="exitBtn" onclick="location.href='../Account/account.html';">Exit</button>
            </div>
        </div>

    </div>
</main>
<footer></footer>
<script>
    cargarTemplate('/Front_end/Header/header.html', 'header');
    cargarTemplate('/Front_end/Nav/nav.html', 'nav');
    cargarTemplate('/Front_end/Footer/footer.html', 'footer')
</script>
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const updateButton = document.getElementById('saveBtn');
        var dataJSON = null
        async function fetchDocument() {
            try {       //Cambiar EMAIL por valor en Local Storage
                const response = await fetch('http://localhost:3000/api/getDocument/usuario/javier.obarreiro@gmai.com');
                if (!response.ok) {
                    throw new Error('Failed to fetch document');
                }
                const data = await response.json();
                dataJSON = data
                return data;
            } catch (error) {
                console.error('Error fetching document:', error.message);
                return null;
            }
        }

        async function fetchImage(documentData) {
            try {
                const response = await fetch('http://localhost:3000/api/getImage/' + documentData['usuario'] + '.png');
                if (!response.ok) {
                    throw new Error('Failed to fetch image');
                }
                const data = await response.json();
                return data.imageUrl;
            } catch (error) {
                console.error('Error fetching image:', error.message);
                return null;
            }
        }

        async function displayDocumentData() {
            const documentData = await fetchDocument();
            if (documentData) {
                console.log(documentData);
                console.log(documentData['nombre']);
                // Update the name element's text content
                document.getElementById('name').placeholder = documentData['nombre'];
                document.getElementById('username').placeholder = documentData['usuario'];
                document.getElementById('email').placeholder = documentData['email'];

                const imageUrl = await fetchImage(documentData);

                const profileImages = document.querySelectorAll('#ProfileImage');

                // Iterate over each element
                profileImages.forEach(imgElement => {
                    // Set the src attribute to the fetched image URL
                    imgElement.src = imageUrl;
                });
            }
        }

        updateButton.addEventListener('click', async function() {
            try {
                //Comprobar cambio de datos
                if (document.getElementById('name').value != "") {
                    dataJSON['nombre'] = document.getElementById('name').value
                } else if (document.getElementById('username').value != "") {
                    dataJSON['usuario'] = document.getElementById('username').value
                } else if (document.getElementById('email').value != "") {
                    dataJSON['email'] = document.getElementById('email').value
                }


                const apiUrl = 'http://localhost:3000/api/changeDoc/usuario/' + dataJSON['email'] + '';

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataJSON)
                });

                if (!response.ok) {
                    throw new Error('Failed to update document');
                }

                const responseData = await response.json();
                console.log('Response:', responseData);
            } catch (error) {
                console.error('Error updating document:', error.message);
            }
        });

        // Call the displayDocumentData function to execute
        displayDocumentData();
    });
</script>

</body>
</html>